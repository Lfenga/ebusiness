<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<base th:href="@{/}">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆ‘çš„è®¢å• - eBusiness</title>
<link rel="stylesheet" href="css/bootstrap.min.css" />
<link rel="stylesheet" href="css/custom.css" />
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/common.js"></script>
<script src="js/starfield.js"></script>
<script src="js/particles.js"></script>
<script type="text/javascript" th:inline="javascript">
	function payOrder(orderId){
		// å…ˆæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
		if (typeof window.showConfirm === 'function') {
			window.showConfirm({
				title: 'ç¡®è®¤æ”¯ä»˜è®¢å•',
				message: 'è®¢å•ç¼–å·ï¼š' + orderId + '<br/>ç¡®è®¤è¦æ”¯ä»˜è¯¥è®¢å•å—ï¼Ÿ',
				type: 'warning',
				confirmText: 'ç¡®è®¤æ”¯ä»˜',
				cancelText: 'å–æ¶ˆ'
			}).then(function(confirmed) {
				if (confirmed) {
					executePayment(orderId);
				}
			});
		} else {
			// é™çº§å¤„ç†
			if(confirm('ç¡®è®¤æ”¯ä»˜è®¢å• ' + orderId + ' å—ï¼Ÿ')){
				executePayment(orderId);
			}
		}
	}
	
	function executePayment(orderId){
		var pathName=window.document.location.pathname;
		var projectName=pathName.substring(0,pathName.substr(1).indexOf('/')+1);
		
		// æ˜¾ç¤ºå¤„ç†ä¸­æç¤º
		showAlert("æ­£åœ¨å¤„ç†æ”¯ä»˜ï¼Œè¯·ç¨å€™...", "info");
		
		$.ajax({
			url : projectName + '/cart/pay',
			type : 'POST',
			contentType : 'application/json',
			data : JSON.stringify({
				id : parseInt(orderId)
			}),
			success : function(result){
				if(result === 'ok'){
					showAlert("ğŸ’³ æ”¯ä»˜æˆåŠŸï¼è®¢å•å·²å®Œæˆ", "success");
					setTimeout(function() {
						location.reload();
					}, 1800);
				} else {
					showAlert("âŒ æ”¯ä»˜å¤±è´¥ï¼š" + result, "error");
				}
			},
	        error : function(xhr, status, error) {
	            showAlert("âš ï¸ æ”¯ä»˜å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•ï¼", "error");
	            console.error('æ”¯ä»˜é”™è¯¯ï¼š', error);
	        }
		});
	}
	
	function showAlert(message, type) {
		// ä½¿ç”¨å…¨å±€çš„showAlertå‡½æ•°ï¼ˆå·²åœ¨common.jsä¸­å®šä¹‰ï¼‰
		if (typeof window.showAlert === 'function') {
			window.showAlert(message, type);
		} else {
			// å…¼åº•æ–¹æ¡ˆ
			alert(message);
		}
	}
</script>
</head>
<body>
<div th:include="user/header"></div>

<div class="container-fluid page-transition" style="margin-top: 30px; margin-bottom: 60px; padding-left: 30px; padding-right: 30px;">
	<!-- é¢åŒ…å±‘å¯¼èˆª -->
	<ol class="breadcrumb breadcrumb-custom" style="margin-bottom: 0;">
		<li><a th:href="@{/}">é¦–é¡µ</a></li>
		<li class="active">æˆ‘çš„è®¢å•</li>
	</ol>
	
	<!-- è®¢å•ç­›é€‰å™¨ -->
	<div class="panel-custom" style="margin-bottom: 0; border-top-left-radius: 0; border-top-right-radius: 0;" th:unless="${#lists.isEmpty(myOrder)}">
		<div class="panel-body" style="padding: 15px;">
			<div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
				<span style="font-weight: 600; color: var(--text-primary);">ğŸ“Š å¿«é€Ÿç­›é€‰ï¼š</span>
				<button class="btn btn-sm btn-default order-filter-btn active" data-status="all">
					å…¨éƒ¨è®¢å•
				</button>
				<button class="btn btn-sm btn-default order-filter-btn" data-status="0">
					ğŸ’° å¾…æ”¯ä»˜
				</button>
				<button class="btn btn-sm btn-default order-filter-btn" data-status="1">
					âœ… å·²æ”¯ä»˜
				</button>
			</div>
		</div>
	</div>
	
	<div class="panel-custom" style="border-top-left-radius: 0; border-top-right-radius: 0;">
		<div class="panel-heading">
			<h3 class="panel-title">ğŸ“¦ æˆ‘çš„è®¢å•</h3>
		</div>
		<div class="panel-body">
			<div class="table-responsive">
				<table class="table table-custom">
					<thead>
						<tr>
							<th class="text-center">è®¢å•ç¼–å·</th>
							<th class="text-center">è®¢å•é‡‘é¢</th>
							<th class="text-center">è®¢å•çŠ¶æ€</th>
							<th class="text-center">ä¸‹å•æ—¶é—´</th>
							<th class="text-center">æ“ä½œ</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="order:${myOrder}">
							<td class="text-center" style="vertical-align: middle; font-weight: 600;">
								<span th:text="${order.id}"></span>
							</td>
						<td class="text-center" style="vertical-align: middle;">
							<span style="color: var(--primary-color); font-weight: 700; font-size: 18px;">
								Â¥<span class="order-amount" th:text="${order.amount}"></span>
							</span>
						</td>
							<td class="text-center" style="vertical-align: middle;">
								<span th:if="${order.status} == 0" class="status-badge status-unpaid">
									ğŸ’° å¾…æ”¯ä»˜
								</span>
								<span th:if="${order.status} == 1" class="status-badge status-paid">
									âœ… å·²æ”¯ä»˜
								</span>
							</td>
							<td class="text-center" style="vertical-align: middle; color: #6C757D;">
								<span th:text="${order.orderdate}"></span>
							</td>
							<td class="text-center" style="vertical-align: middle;">
								<a th:href="@{/cart/orderDetail(id=${order.id})}" 
								   class="btn btn-sm btn-custom-secondary" 
								   target="_blank">
									ğŸ‘ï¸ æŸ¥çœ‹è¯¦æƒ…
								</a>
								<button th:if="${order.status} == 0" 
										th:onclick="'payOrder(' + ${order.id} + ')'"
										class="btn btn-sm btn-custom-primary" 
										style="margin-left: 5px;">
									ğŸ’³ å»æ”¯ä»˜
								</button>
							</td>
						</tr>
						<!-- ç©ºçŠ¶æ€æç¤º -->
						<tr th:if="${#lists.isEmpty(myOrder)}">
							<td colspan="5">
							<div class="empty-state">
								<div class="empty-state-icon">ğŸ“¦</div>
								<p class="empty-state-text">æš‚æ— è®¢å•è®°å½•</p>
								<a th:href="@{/}" class="btn btn-custom-primary">å»è´­ç‰©</a>
							</div>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			
			<!-- åˆ†é¡µç»„ä»¶ -->
			<div th:unless="${#lists.isEmpty(myOrder)}" style="margin-top: 20px; display: flex; justify-content: center;">
				<nav>
					<ul class="pagination pagination-custom">
						<!-- ä¸Šä¸€é¡µ -->
						<li th:class="${currentPage == 1} ? 'disabled' : ''">
							<a th:href="${currentPage == 1} ? 'javascript:void(0)' : @{/cart/myOder(page=${currentPage - 1})}" aria-label="ä¸Šä¸€é¡µ">
								<span aria-hidden="true">&laquo; ä¸Šä¸€é¡µ</span>
							</a>
						</li>
						
						<!-- é¡µç  -->
						<li th:each="i : ${#numbers.sequence(1, totalPages)}" 
							th:class="${i == currentPage} ? 'active' : ''">
							<a th:href="@{/cart/myOder(page=${i})}" th:text="${i}">1</a>
						</li>
						
						<!-- ä¸‹ä¸€é¡µ -->
						<li th:class="${currentPage == totalPages} ? 'disabled' : ''">
							<a th:href="${currentPage == totalPages} ? 'javascript:void(0)' : @{/cart/myOder(page=${currentPage + 1})}" aria-label="ä¸‹ä¸€é¡µ">
								<span aria-hidden="true">ä¸‹ä¸€é¡µ &raquo;</span>
							</a>
						</li>
					</ul>
					
					<!-- åˆ†é¡µä¿¡æ¯ -->
					<div style="text-align: center; margin-top: 10px; color: var(--text-secondary);">
						å…± <span style="font-weight: 600; color: var(--primary-color);" th:text="${totalOrders}">0</span> æ¡è®°å½•ï¼Œ
						å½“å‰ç¬¬ <span style="font-weight: 600; color: var(--primary-color);" th:text="${currentPage}">1</span> / 
						<span th:text="${totalPages}">1</span> é¡µ
					</div>
				</nav>
			</div>
		</div>
	</div>
</div>

<script>
$(document).ready(function() {
	// ä¸ºè®¢å•é‡‘é¢æ·»åŠ æ•°å­—æ»šåŠ¨åŠ¨ç”»
	$('.order-amount').each(function(index) {
		var $this = $(this);
		var finalValue = parseFloat($this.text());
		if (!isNaN(finalValue) && window.particleSystem) {
			setTimeout(function() {
				window.particleSystem.animateNumber($this[0], 0, finalValue, 800);
			}, index * 100);
		}
	});
	
	// è®¢å•ç­›é€‰åŠŸèƒ½
	$('.order-filter-btn').on('click', function() {
		var status = $(this).data('status');
		$('.order-filter-btn').removeClass('active');
		$(this).addClass('active');
		
		if (status === 'all') {
			// æ˜¾ç¤ºæ‰€æœ‰è®¢å•è¡Œï¼ˆä½†ä¸åŒ…æ‹¬ç©ºçŠ¶æ€æç¤ºè¡Œï¼‰
			$('tbody tr').each(function() {
				if (!$(this).find('.empty-state').length) {
					$(this).show();
				}
			});
		} else {
			// æ ¹æ®çŠ¶æ€ç­›é€‰
			$('tbody tr').each(function() {
				var $statusBadge = $(this).find('.status-badge');
				// è·³è¿‡ç©ºçŠ¶æ€è¡Œ
				if ($(this).find('.empty-state').length) {
					return;
				}
				
				if ($statusBadge.length > 0) {
					if ((status == 0 && $statusBadge.hasClass('status-unpaid')) ||
						(status == 1 && $statusBadge.hasClass('status-paid'))) {
						$(this).show();
					} else {
						$(this).hide();
					}
				}
			});
		}
	});
	
	// æ”¯ä»˜æˆåŠŸåçš„ç¤¼èŠ±åŠ¨ç”»
	var urlParams = new URLSearchParams(window.location.search);
	if (urlParams.get('paySuccess') === 'true' && window.particleSystem) {
		window.particleSystem.createConfetti(50);
		window.particleSystem.showToast('ğŸ‰ æ”¯ä»˜æˆåŠŸï¼', 'success', 3000);
	}
});
</script>
</body>
</html>
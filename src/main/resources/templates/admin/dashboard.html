<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>æ•°æ®ç»Ÿè®¡ä»ªè¡¨ç›˜ - ç”µå•†ç®¡ç†ç³»ç»Ÿ</title>
    <base th:href="@{/}">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/ruoyi-admin.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/common.js"></script>
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .summary-card .card-icon {
            font-size: 48px;
            float: left;
            margin-right: 20px;
            opacity: 0.8;
        }
        
        .summary-card .card-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .summary-card .card-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .chart {
            width: 100%;
            height: 400px;
        }
        
        .chart-small {
            height: 300px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #999;
        }
        
        /* é¢œè‰²æ–¹æ¡ˆ */
        .color-primary { color: #667eea; }
        .color-success { color: #48c774; }
        .color-warning { color: #ffdd57; }
        .color-danger { color: #f14668; }
        .color-info { color: #3298dc; }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <div th:replace="admin/header::myheader"></div>
    
    <div class="main-content">
        <div class="page-container" style="max-width: none;">
        <!-- æ ‡é¢˜ -->
        <div class="dashboard-header">
            <h1 style="margin: 0;">ğŸ“Š æ•°æ®ç»Ÿè®¡ä»ªè¡¨ç›˜</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">å®æ—¶ç›‘æ§ä¸šåŠ¡æ•°æ®ï¼Œæ´å¯Ÿè¿è¥è¶‹åŠ¿</p>
        </div>
        
        <!-- æ±‡æ€»å¡ç‰‡ -->
        <div class="row" id="summaryCards">
            <div class="col-md-3">
                <div class="summary-card">
                    <div class="card-icon color-primary">ğŸ‘¥</div>
                    <div>
                        <div class="card-value" id="totalUsers">-</div>
                        <div class="card-label">æ€»ç”¨æˆ·æ•°</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <div class="card-icon color-success">ğŸ“¦</div>
                    <div>
                        <div class="card-value" id="totalOrders">-</div>
                        <div class="card-label">æ€»è®¢å•æ•°</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <div class="card-icon color-warning">ğŸ’°</div>
                    <div>
                        <div class="card-value" id="totalSales">-</div>
                        <div class="card-label">æ€»é”€å”®é¢ï¼ˆå…ƒï¼‰</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <div class="card-icon color-danger">ğŸ“ˆ</div>
                    <div>
                        <div class="card-value" id="conversionRate">-</div>
                        <div class="card-label">è´­ç‰©è½¦è½¬åŒ–ç‡</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä»Šæ—¥æ•°æ® -->
        <div class="row">
            <div class="col-md-4">
                <div class="summary-card">
                    <div class="card-icon color-info">ğŸ¯</div>
                    <div>
                        <div class="card-value" id="todayOrders">-</div>
                        <div class="card-label">ä»Šæ—¥è®¢å•</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="summary-card">
                    <div class="card-icon color-success">ğŸ’µ</div>
                    <div>
                        <div class="card-value" id="todaySales">-</div>
                        <div class="card-label">ä»Šæ—¥é”€å”®é¢ï¼ˆå…ƒï¼‰</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="summary-card">
                    <div class="card-icon color-warning">âš ï¸</div>
                    <div>
                        <div class="card-value" id="lowStockCount">-</div>
                        <div class="card-label">ä½åº“å­˜é¢„è­¦</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é”€å”®è¶‹åŠ¿å›¾ -->
        <div class="row">
            <div class="col-md-12">
                <div class="chart-container">
                    <div class="chart-title">ğŸ“ˆ é”€å”®è¶‹åŠ¿åˆ†æï¼ˆæœ€è¿‘30å¤©ï¼‰</div>
                    <div>
                        <button class="btn btn-sm btn-default" onclick="changeSalesPeriod('day', 30)">æŒ‰å¤©</button>
                        <button class="btn btn-sm btn-default" onclick="changeSalesPeriod('week', 12)">æŒ‰å‘¨</button>
                        <button class="btn btn-sm btn-default" onclick="changeSalesPeriod('month', 12)">æŒ‰æœˆ</button>
                    </div>
                    <div id="salesTrendChart" class="chart"></div>
                </div>
            </div>
        </div>
        
        <!-- å•†å“é”€å”®æ’è¡Œå’Œç±»å‹é”€å”® -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">ğŸ† å•†å“é”€å”®æ’è¡Œ TOP10</div>
                    <div id="goodsRankChart" class="chart chart-small"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">ğŸ¨ å•†å“ç±»å‹é”€å”®å æ¯”</div>
                    <div id="typeSalesChart" class="chart chart-small"></div>
                </div>
            </div>
        </div>
        
        <!-- ç”¨æˆ·æ´»è·ƒåº¦å’Œè®¢å•çŠ¶æ€ -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">ğŸ‘¤ ç”¨æˆ·æ´»è·ƒåº¦è¶‹åŠ¿</div>
                    <div id="userActivityChart" class="chart chart-small"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">ğŸ“‹ è®¢å•çŠ¶æ€åˆ†å¸ƒ</div>
                    <div id="orderStatusChart" class="chart chart-small"></div>
                </div>
            </div>
        </div>
        
        <!-- ç®¡ç†å‘˜æ“ä½œç»Ÿè®¡ -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">ğŸ”§ ç®¡ç†å‘˜æ“ä½œç±»å‹åˆ†å¸ƒ</div>
                    <div id="adminOperationTypeChart" class="chart chart-small"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">ğŸ“Š ç®¡ç†å‘˜æ“ä½œæ¨¡å—åˆ†å¸ƒ</div>
                    <div id="adminOperationModuleChart" class="chart chart-small"></div>
                </div>
            </div>
        </div>
        
        <!-- ç”¨æˆ·æ´»è·ƒæ—¶æ®µçƒ­åŠ›å›¾ -->
        <div class="row">
            <div class="col-md-12">
                <div class="chart-container">
                    <div class="chart-title">ğŸ”¥ ç”¨æˆ·æ´»è·ƒæ—¶æ®µçƒ­åŠ›å›¾ï¼ˆæœ€è¿‘30å¤©ï¼‰</div>
                    <div id="activityHeatmapChart" class="chart"></div>
                </div>
            </div>
        </div>
        
        <!-- ä»·æ ¼ä¸é”€é‡å…³ç³» -->
        <div class="row">
            <div class="col-md-12">
                <div class="chart-container">
                    <div class="chart-title">ğŸ’ å•†å“ä»·æ ¼ä¸é”€é‡å…³ç³»</div>
                    <div id="priceVsSalesChart" class="chart chart-small"></div>
                </div>
            </div>
        </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        // è·å–é¡¹ç›®ä¸Šä¸‹æ–‡è·¯å¾„
        var contextPath = /*[[${#httpServletRequest.getContextPath()}]]*/ '';
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        $(document).ready(function() {
            loadSummaryData();
            loadSalesTrend('day', 30);
            loadGoodsRank();
            loadTypeSales();
            loadUserActivity();
            loadOrderStatus();
            loadAdminOperationStats();
            loadActivityHeatmap();
            loadPriceVsSales();
        });
        
        // åŠ è½½æ±‡æ€»æ•°æ®
        function loadSummaryData() {
            $.ajax({
                url: contextPath + '/statistics/summary',
                method: 'GET',
                success: function(data) {
                    $('#totalUsers').text(data.totalUsers || 0);
                    $('#totalOrders').text(data.totalOrders || 0);
                    $('#totalSales').text(formatMoney(data.totalSales || 0));
                    $('#conversionRate').text((data.conversionRate || 0) + '%');
                    $('#todayOrders').text(data.todayOrders || 0);
                    $('#todaySales').text(formatMoney(data.todaySales || 0));
                    $('#lowStockCount').text(data.lowStockCount || 0);
                },
                error: function() {
                    console.error('åŠ è½½æ±‡æ€»æ•°æ®å¤±è´¥');
                }
            });
        }
        
        // åŠ è½½é”€å”®è¶‹åŠ¿
        function loadSalesTrend(period, count) {
            $.ajax({
                url: contextPath + '/statistics/sales/trend',
                method: 'GET',
                data: { period: period, count: count },
                success: function(data) {
                    renderSalesTrendChart(data);
                }
            });
        }
        
        // åˆ‡æ¢é”€å”®è¶‹åŠ¿å‘¨æœŸ
        function changeSalesPeriod(period, count) {
            loadSalesTrend(period, count);
        }
        
        // æ¸²æŸ“é”€å”®è¶‹åŠ¿å›¾
        function renderSalesTrendChart(data) {
            var chart = echarts.init(document.getElementById('salesTrendChart'));
            var dates = data.map(item => item.date);
            var orders = data.map(item => item.orderCount);
            var sales = data.map(item => item.salesAmount);
            
            var option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: {
                    data: ['è®¢å•æ•°é‡', 'é”€å”®é¢']
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: { rotate: 45 }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'è®¢å•æ•°é‡',
                        position: 'left'
                    },
                    {
                        type: 'value',
                        name: 'é”€å”®é¢ï¼ˆå…ƒï¼‰',
                        position: 'right'
                    }
                ],
                series: [
                    {
                        name: 'è®¢å•æ•°é‡',
                        type: 'line',
                        data: orders,
                        smooth: true,
                        itemStyle: { color: '#667eea' }
                    },
                    {
                        name: 'é”€å”®é¢',
                        type: 'line',
                        yAxisIndex: 1,
                        data: sales,
                        smooth: true,
                        itemStyle: { color: '#48c774' }
                    }
                ]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
        
        // åŠ è½½å•†å“é”€å”®æ’è¡Œ
        function loadGoodsRank() {
            $.ajax({
                url: contextPath + '/statistics/goods/rank',
                method: 'GET',
                data: { type: 'count', limit: 10 },
                success: function(data) {
                    renderGoodsRankChart(data);
                }
            });
        }
        
        // æ¸²æŸ“å•†å“é”€å”®æ’è¡Œå›¾
        function renderGoodsRankChart(data) {
            var chart = echarts.init(document.getElementById('goodsRankChart'));
            var names = data.map(item => item.goodsName);
            var counts = data.map(item => item.salesCount);
            
            var option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                xAxis: {
                    type: 'value'
                },
                yAxis: {
                    type: 'category',
                    data: names.reverse()
                },
                series: [{
                    type: 'bar',
                    data: counts.reverse(),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ])
                    },
                    label: {
                        show: true,
                        position: 'right'
                    }
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
        
        // åŠ è½½å•†å“ç±»å‹é”€å”®
        function loadTypeSales() {
            $.ajax({
                url: contextPath + '/statistics/type/sales',
                method: 'GET',
                success: function(data) {
                    renderTypeSalesChart(data);
                }
            });
        }
        
        // æ¸²æŸ“å•†å“ç±»å‹é”€å”®é¥¼å›¾
        function renderTypeSalesChart(data) {
            var chart = echarts.init(document.getElementById('typeSalesChart'));
            var chartData = data.map(item => ({
                name: item.typeName,
                value: item.salesAmount
            }));
            
            var option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center'
                },
                series: [{
                    name: 'é”€å”®é¢',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}: {d}%'
                    },
                    data: chartData
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
        
        // åŠ è½½ç”¨æˆ·æ´»è·ƒåº¦
        function loadUserActivity() {
            $.ajax({
                url: contextPath + '/statistics/user/activity',
                method: 'GET',
                data: { days: 30 },
                success: function(data) {
                    renderUserActivityChart(data);
                }
            });
        }
        
        // æ¸²æŸ“ç”¨æˆ·æ´»è·ƒåº¦å›¾
        function renderUserActivityChart(data) {
            var chart = echarts.init(document.getElementById('userActivityChart'));
            var dates = data.map(item => item.date);
            var newUsers = data.map(item => item.newUsers);
            var activeUsers = data.map(item => item.activeUsers);
            
            var option = {
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['æ–°å¢ç”¨æˆ·', 'æ´»è·ƒç”¨æˆ·']
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: { rotate: 45 }
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        name: 'æ–°å¢ç”¨æˆ·',
                        type: 'line',
                        data: newUsers,
                        smooth: true,
                        itemStyle: { color: '#3298dc' }
                    },
                    {
                        name: 'æ´»è·ƒç”¨æˆ·',
                        type: 'line',
                        data: activeUsers,
                        smooth: true,
                        itemStyle: { color: '#48c774' }
                    }
                ]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
        
        // åŠ è½½è®¢å•çŠ¶æ€
        function loadOrderStatus() {
            $.ajax({
                url: contextPath + '/statistics/order/status',
                method: 'GET',
                success: function(data) {
                    renderOrderStatusChart(data);
                }
            });
        }
        
        // æ¸²æŸ“è®¢å•çŠ¶æ€é¥¼å›¾
        function renderOrderStatusChart(data) {
            var chart = echarts.init(document.getElementById('orderStatusChart'));
            var chartData = data.map(item => ({
                name: item.statusName,
                value: item.count
            }));
            
            var option = {
                tooltip: {
                    trigger: 'item'
                },
                legend: {
                    bottom: 10
                },
                series: [{
                    type: 'pie',
                    radius: '60%',
                    data: chartData,
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
        
        // åŠ è½½ç®¡ç†å‘˜æ“ä½œç»Ÿè®¡
        function loadAdminOperationStats() {
            $.ajax({
                url: contextPath + '/statistics/admin/operation',
                method: 'GET',
                success: function(data) {
                    renderAdminOperationCharts(data);
                }
            });
        }
        
        // æ¸²æŸ“ç®¡ç†å‘˜æ“ä½œç»Ÿè®¡å›¾
        function renderAdminOperationCharts(data) {
            // æ“ä½œç±»å‹åˆ†å¸ƒ
            var typeChart = echarts.init(document.getElementById('adminOperationTypeChart'));
            var typeOption = {
                tooltip: {
                    trigger: 'item'
                },
                series: [{
                    type: 'pie',
                    radius: '60%',
                    data: data.operationType,
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            typeChart.setOption(typeOption);
            
            // æ“ä½œæ¨¡å—åˆ†å¸ƒ
            var moduleChart = echarts.init(document.getElementById('adminOperationModuleChart'));
            var moduleOption = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                xAxis: {
                    type: 'category',
                    data: data.operationModule.map(item => item.name)
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    type: 'bar',
                    data: data.operationModule.map(item => item.value),
                    itemStyle: {
                        color: '#667eea'
                    }
                }]
            };
            moduleChart.setOption(moduleOption);
            
            window.addEventListener('resize', () => {
                typeChart.resize();
                moduleChart.resize();
            });
        }
        
        // åŠ è½½æ´»è·ƒæ—¶æ®µçƒ­åŠ›å›¾
        function loadActivityHeatmap() {
            $.ajax({
                url: contextPath + '/statistics/heatmap/activity',
                method: 'GET',
                data: { days: 30 },
                success: function(data) {
                    renderActivityHeatmap(data);
                }
            });
        }
        
        // æ¸²æŸ“æ´»è·ƒæ—¶æ®µçƒ­åŠ›å›¾
        function renderActivityHeatmap(data) {
            var chart = echarts.init(document.getElementById('activityHeatmapChart'));
            var hours = [];
            var days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            for (var i = 0; i < 24; i++) {
                hours.push(i + ':00');
            }
            
            var heatmapData = data.map(item => [item.hour, item.weekday - 1, item.orderCount]);
            
            var option = {
                tooltip: {
                    position: 'top',
                    formatter: function(params) {
                        return days[params.value[1]] + ' ' + hours[params.value[0]] + '<br/>è®¢å•æ•°: ' + params.value[2];
                    }
                },
                grid: {
                    height: '70%',
                    top: '10%'
                },
                xAxis: {
                    type: 'category',
                    data: hours,
                    splitArea: {
                        show: true
                    }
                },
                yAxis: {
                    type: 'category',
                    data: days,
                    splitArea: {
                        show: true
                    }
                },
                visualMap: {
                    min: 0,
                    max: Math.max(...heatmapData.map(item => item[2])),
                    calculable: true,
                    orient: 'horizontal',
                    left: 'center',
                    bottom: '5%',
                    inRange: {
                        color: ['#f0f9ff', '#0ea5e9', '#0284c7', '#0c4a6e']
                    }
                },
                series: [{
                    type: 'heatmap',
                    data: heatmapData,
                    label: {
                        show: false
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
        
        // åŠ è½½ä»·æ ¼ä¸é”€é‡å…³ç³»
        function loadPriceVsSales() {
            $.ajax({
                url: contextPath + '/statistics/price-sales',
                method: 'GET',
                success: function(data) {
                    renderPriceVsSalesChart(data);
                }
            });
        }
        
        // æ¸²æŸ“ä»·æ ¼ä¸é”€é‡æ•£ç‚¹å›¾
        function renderPriceVsSalesChart(data) {
            var chart = echarts.init(document.getElementById('priceVsSalesChart'));
            var scatterData = data.map(item => [item.price, item.sales, item.name]);
            
            var option = {
                tooltip: {
                    formatter: function(params) {
                        return params.value[2] + '<br/>ä»·æ ¼: Â¥' + params.value[0] + '<br/>é”€é‡: ' + params.value[1];
                    }
                },
                xAxis: {
                    type: 'value',
                    name: 'ä»·æ ¼ï¼ˆå…ƒï¼‰',
                    nameLocation: 'middle',
                    nameGap: 30
                },
                yAxis: {
                    type: 'value',
                    name: 'é”€é‡',
                    nameLocation: 'middle',
                    nameGap: 40
                },
                series: [{
                    type: 'scatter',
                    symbolSize: 10,
                    data: scatterData,
                    itemStyle: {
                        color: '#667eea',
                        opacity: 0.7
                    },
                    emphasis: {
                        itemStyle: {
                            color: '#764ba2'
                        }
                    }
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
        
        // æ ¼å¼åŒ–é‡‘é¢
        function formatMoney(amount) {
            return parseFloat(amount).toFixed(2);
        }
    </script>
</body>
</html>

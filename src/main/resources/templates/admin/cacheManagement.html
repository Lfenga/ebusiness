<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ç¼“å­˜ç®¡ç† - ç”µå•†ç®¡ç†ç³»ç»Ÿ</title>
    <base th:href="@{/}">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/ruoyi-admin.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/common.js"></script>
    <style>
        .cache-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .cache-panel h3 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .quick-action-btn {
            margin: 5px;
        }
        
        .cache-stat-item {
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .cache-stat-item h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }
        
        .stat-detail {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <div th:replace="admin/header::myheader"></div>
    
    <div class="main-content">
        <div class="page-container">
            <h2 class="page-title">ğŸš€ ç¼“å­˜ç®¡ç†ä¸­å¿ƒ</h2>
            
            <!-- å¿«æ·æ“ä½œ -->
            <div class="cache-panel">
                <h3>âš¡ å¿«æ·æ“ä½œ</h3>
                <button class="btn btn-primary quick-action-btn" onclick="clearGoodsTypesCache()">
                    <i class="glyphicon glyphicon-trash"></i> æ¸…é™¤å•†å“ç±»å‹ç¼“å­˜
                </button>
                <button class="btn btn-primary quick-action-btn" onclick="clearLastedGoodsCache()">
                    <i class="glyphicon glyphicon-trash"></i> æ¸…é™¤é¦–é¡µå•†å“åˆ—è¡¨
                </button>
                <button class="btn btn-primary quick-action-btn" onclick="clearGoodsDetailCache()">
                    <i class="glyphicon glyphicon-trash"></i> æ¸…é™¤å•†å“è¯¦æƒ…ç¼“å­˜
                </button>
                <button class="btn btn-primary quick-action-btn" onclick="clearSearchCache()">
                    <i class="glyphicon glyphicon-trash"></i> æ¸…é™¤æœç´¢ç»“æœç¼“å­˜
                </button>
                <button class="btn btn-warning quick-action-btn" onclick="clearAllCache()">
                    <i class="glyphicon glyphicon-warning-sign"></i> æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
                </button>
                <button class="btn btn-success quick-action-btn" onclick="refreshStats()">
                    <i class="glyphicon glyphicon-refresh"></i> åˆ·æ–°ç»Ÿè®¡
                </button>
            </div>
            
            <!-- ç¼“å­˜ç»Ÿè®¡ -->
            <div class="cache-panel">
                <h3>ğŸ“Š ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯</h3>
                <div id="cacheStatsList">
                    <div class="cache-stat-item" th:each="stat : ${cacheStats}">
                        <h4 th:text="${stat.cacheLevel}">ç¼“å­˜å±‚çº§</h4>
                        <div class="stat-detail">
                            <span>å‘½ä¸­ç‡:</span>
                            <strong th:text="${#numbers.formatDecimal(stat.hitRate, 1, 2)} + '%'">-</strong>
                        </div>
                        <div class="stat-detail">
                            <span>å‘½ä¸­æ¬¡æ•°:</span>
                            <strong th:text="${stat.hitCount}">-</strong>
                        </div>
                        <div class="stat-detail">
                            <span>æœªå‘½ä¸­æ¬¡æ•°:</span>
                            <strong th:text="${stat.missCount}">-</strong>
                        </div>
                        <div class="stat-detail">
                            <span>æ€»è¯·æ±‚æ¬¡æ•°:</span>
                            <strong th:text="${stat.requestCount}">-</strong>
                        </div>
                        <div class="stat-detail">
                            <span>ç¼“å­˜æ¡ç›®æ•°:</span>
                            <strong th:text="${stat.cacheSize}">-</strong>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜ -->
            <div class="cache-panel">
                <h3>ğŸ”§ æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜</h3>
                <div class="form-group">
                    <label>é€‰æ‹©ç¼“å­˜é”®:</label>
                    <select id="cacheKeySelect" class="form-control">
                        <option value="">-- è¯·é€‰æ‹©ç¼“å­˜é”® --</option>
                        <option th:each="key : ${cacheKeys}" th:value="${key}" th:text="${key}"></option>
                    </select>
                </div>
                <button class="btn btn-danger" onclick="evictCacheKey()">
                    <i class="glyphicon glyphicon-remove"></i> æ¸…é™¤æŒ‡å®šé”®
                </button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>é€‰æ‹©ç¼“å­˜æ¨¡å¼:</label>
                    <select id="patternSelect" class="form-control">
                        <option value="">-- è¯·é€‰æ‹©ç¼“å­˜æ¨¡å¼ --</option>
                        <option th:each="pattern : ${cachePatterns}" th:value="${pattern}" th:text="${pattern}"></option>
                    </select>
                </div>
                <button class="btn btn-warning" onclick="evictByPattern()">
                    <i class="glyphicon glyphicon-filter"></i> æŒ‰æ¨¡å¼æ¸…é™¤
                </button>
            </div>
        </div>
    </div>
    
    <script>
        var contextPath = '/eBusiness';
        
        // æ¸…é™¤å•†å“ç±»å‹ç¼“å­˜
        function clearGoodsTypesCache() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤å•†å“ç±»å‹ç¼“å­˜å—ï¼Ÿ')) {
                return;
            }
            quickClear('/admin/cache/quickClear/goodsTypes');
        }
        
        // æ¸…é™¤é¦–é¡µå•†å“åˆ—è¡¨
        function clearLastedGoodsCache() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤é¦–é¡µå•†å“åˆ—è¡¨ç¼“å­˜å—ï¼Ÿ')) {
                return;
            }
            quickClear('/admin/cache/quickClear/lastedGoods');
        }
        
        // æ¸…é™¤å•†å“è¯¦æƒ…ç¼“å­˜
        function clearGoodsDetailCache() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤å•†å“è¯¦æƒ…ç¼“å­˜å—ï¼Ÿ')) {
                return;
            }
            quickClear('/admin/cache/quickClear/goodsDetail');
        }
        
        // æ¸…é™¤æœç´¢ç»“æœç¼“å­˜
        function clearSearchCache() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æœç´¢ç»“æœç¼“å­˜å—ï¼Ÿ')) {
                return;
            }
            quickClear('/admin/cache/quickClear/search');
        }
        
        // å¿«æ·æ¸…é™¤é€šç”¨æ–¹æ³•
        function quickClear(url) {
            $.ajax({
                url: contextPath + url,
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        showAlert(response.message, 'success');
                        setTimeout(refreshStats, 500);
                    } else {
                        showAlert(response.message, 'warning');
                    }
                },
                error: function() {
                    showAlert('æ¸…é™¤ç¼“å­˜å¤±è´¥', 'danger');
                }
            });
        }
        
        // æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
        function clearAllCache() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜å—ï¼Ÿè¿™å°†å½±å“ç³»ç»Ÿæ€§èƒ½ï¼')) {
                return;
            }
            
            $.ajax({
                url: contextPath + '/admin/cache/evictAll',
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        showAlert(response.message, 'success');
                        setTimeout(refreshStats, 500);
                    } else {
                        showAlert(response.message, 'warning');
                    }
                },
                error: function() {
                    showAlert('æ¸…ç©ºç¼“å­˜å¤±è´¥', 'danger');
                }
            });
        }
        
        // æ¸…é™¤æŒ‡å®šé”®
        function evictCacheKey() {
            var cacheKey = $('#cacheKeySelect').val();
            if (!cacheKey) {
                showAlert('è¯·é€‰æ‹©ç¼“å­˜é”®', 'warning');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æ¸…é™¤ç¼“å­˜é”®: ' + cacheKey + ' å—ï¼Ÿ')) {
                return;
            }
            
            $.ajax({
                url: contextPath + '/admin/cache/evict',
                method: 'POST',
                data: { cacheKey: cacheKey },
                success: function(response) {
                    if (response.success) {
                        showAlert(response.message, 'success');
                        $('#cacheKeySelect').val('');
                        setTimeout(refreshStats, 500);
                    } else {
                        showAlert(response.message, 'warning');
                    }
                },
                error: function() {
                    showAlert('æ¸…é™¤ç¼“å­˜å¤±è´¥', 'danger');
                }
            });
        }
        
        // æŒ‰æ¨¡å¼æ¸…é™¤
        function evictByPattern() {
            var pattern = $('#patternSelect').val();
            if (!pattern) {
                showAlert('è¯·é€‰æ‹©ç¼“å­˜æ¨¡å¼', 'warning');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æŒ‰æ¨¡å¼æ¸…é™¤ç¼“å­˜: ' + pattern + ' å—ï¼Ÿ')) {
                return;
            }
            
            $.ajax({
                url: contextPath + '/admin/cache/evictByPattern',
                method: 'POST',
                data: { keyPattern: pattern },
                success: function(response) {
                    if (response.success) {
                        showAlert(response.message, 'success');
                        $('#patternSelect').val('');
                        setTimeout(refreshStats, 500);
                    } else {
                        showAlert(response.message, 'warning');
                    }
                },
                error: function() {
                    showAlert('æ¸…é™¤ç¼“å­˜å¤±è´¥', 'danger');
                }
            });
        }
        
        // åˆ·æ–°ç»Ÿè®¡
        function refreshStats() {
            location.reload();
        }
    </script>
</body>
</html>
